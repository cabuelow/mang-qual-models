---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(igraph)
library(QPress)
library(dplyr)
library(ggplot2)
theme_set(theme_classic())
```

# How to build a model 
### Mangrove response to climate change and other anthropogenic threats

Taking a 'one model to rule them all approach' vs. multiple, individual models for different scenarios.

Aim is to build one model that performs as expected under different scenarios.

Then we can map likelihood of increase or decrease in mangrove extent, given different drivers

Steps are to:

1) Build and visualise the conceptual model
2) Perturb drivers to examine expected responses of mangroves under different scenarios
3) If responses are not expected, re-work the conceptual model and do step 2
4) Map likelihood of mangroves increasing or decreasing given different geomorphologies and drivers
5) Validate with GMW data (if possible)

### 1. Build and visualise conceptual model

Variables are in white and drivers are in grey. Red arrows indicate negative effect, black arrows indicate positive effect.

**TODO: change 'front and back' mangroves to 'seaward and landward' mangroves.

```{r}
base_model <- c('BackLatAccom->BackPropag',
                'BackPropag->BackMang',
                #'BackMang-*BackMang',
                #'BackMang->SubVol',
                'FrontLatAccom->FrontPropag',
                'FrontPropag->FrontMang',
                #'FrontMang-*FrontMang',
                #'FrontMang->SubVol',
                'Cyclones-*BackMang',
                'Cyclones-*FrontMang',
                'Restore->BackPropag',
                'Restore->FrontPropag',
                'CoastDevel-*BackLatAccom',
                'SeaLevel->BackLatAccom',
                'SeaLevel-*FrontMang',
                'SeaLevel-*FrontLatAccom',
                'SubVol->FrontLatAccom',
                #'SubVol-*SubVol',
                'TidalAmp->BackLatAccom',
                'TidalAmp->FrontLatAccom',
                #'TidalAmp-*SubVol',
                'Autocompaction-*SubVol',
                'SedSupply->SubVol',
                'Dams-*SedSupply',
                #'HydrodynEnergy-*FrontPropag',
                'HydrodynEnergy-*FrontLatAccom'
                #'OM->SubVol',
                #'BackMang->OM',
                #'FrontMang->OM'
                )
                
drivers <- c("Cyclones","SeaLevFall","Restore","CoastDevel",
             "SeaLevel","TidalAmp","Autocompaction", "SedSupply", "Dams")
modelA <- parse.digraph(base_model)
modelA <- enforce.limitation(modelA)
wA <- adjacency.matrix(modelA, labels=TRUE)
stable.community(wA) #stable model?
det(wA) # is matrix singular?
```


```{r dpi=300, fig.width=7, fig.height=7}
plotmodel <- function(modelA){
w <- adjacency.matrix(modelA, labels=TRUE)
gdat <- graph_from_adjacency_matrix(t(w),
                                    mode = "directed",
                                    weighted = "b")
E(gdat)$color <- ifelse(E(gdat)$b <0, "red", "black")
V(gdat)$color <- ifelse(names(V(gdat)) %in% drivers, "grey", "white")
plot(gdat, 
     vertex.size = 20,
     vertex.label.cex = 0.6,
     vertex.label.color = "black",
     edge.arrow.size = 0.5,
     #edge.label = letters[1:length(E(gdat))],
     edge.label.cex = 0.9,
     edge.label.color = "black",
     edge.label.pos = 1)
}
plotmodel(modelA)
```
**TODO: Would like to have an 'organic matter' variable that can have a positive effect on substrate volume (SubVol), and is positively influenced by front and back mangroves. Substrate volume should also perhaps be influenced by hydroperiod? High frequency of tidal inundation means sediment and organic matter less able to settle to the bottom?

*Note, only way to get a stable model was to enforce self-limitation on all variables.

### 2) Perturb drivers to examine expected responses of mangroves under different scenarios

#### Scenario 1: High sediment supply
Expect front of mangroves to increase

```{r}
impactSedSupply <- press.impact(modelA, perturb = c(SedSupply=1))
round(impactSedSupply(wA),2)
```
So the net feedback is for mangrove increase.

#### Scenario 2: High sediment supply and sea-level fall (e.g., during drought)

Expect front mangroves to increase (progradation) and mangrove dieback in the back.

```{r}
impactSedSupply_SLF <- press.impact(modelA, perturb = c(SedSupply=1,
                                                        SeaLevel=-1))
impactSedSupply_SLF(wA)
```
Front mangroves increase and back die.

#### Scenario 3: High sediment supply and sea-level rise

```{r}
impactSedSupply_SLR <- press.impact(modelA, perturb = c(SedSupply=1,
                                                        SeaLevel=1))
impactSedSupply_SLR(wA)
```
Back mangroves increase, but front decrease. Not what we would expect

#### Scenario 4: Sea-level rise
Expect landward mangroves to increase

```{r}
impactSLR <- press.impact(modelA, perturb = c(SeaLevel=1))
impactSLR(wA)
```
Landward mangroves increase as expected. Front mangroves decrease, as expected.

### Simulate scenarios and compare outcomes

The above assumed that the weights of all processes are equal.
We can additionally do simulations where we randomly vary the weights.
Not implemented here, but we should also consider adding constraints where we say weight of one path is greater than an alternate path. Will need your help deciding on those constraints though. 

```{r}
#Simulate scenarios for modelB. 
# note that model and impact scenarios are hard coded
#maybe slow if there are a lot of non-stable communities generated
simulate_scenarios <- function(i){
  
  simB <- community.sampler(modelA)
  
  wA <- adjacency.matrix(modelA, labels=TRUE)
  varnames <- names(impactSLR(wA))
  
  stable_comm <- FALSE
  
  while(!stable_comm){
    w <- simB$community()
    stable_comm <- stable.community(w)
  }
  
  modout <- data.frame(vars = rep(varnames, 4), 
                       isim = i,
                       scnr = rep(c("Sediment supply", "SLR", 
                                    "Sediment supply & SLF",
                                    "Sediment supply & SLR"), 
                                  each = 4),
                       outcomes = c(impactSedSupply(w),
                                    impactSLR(w),
                                    impactSedSupply_SLF(w),
                                    impactSedSupply_SLR(w))
  )
  return(modout)
}
modout <- lapply(1:1000, simulate_scenarios)
modout <- do.call("rbind", modout)
```

Below graph shows proportion of positive change predicted across 1000 models with randomized weights. 

```{r}
#summarize results
modsum <- modout %>% group_by(vars, scnr) %>%
  summarize(net_change = sum(outcomes>0)/n())
ggplot(modsum) +
  aes(x = scnr, y = net_change) + 
  geom_bar(stat = 'identity') + 
  facet_wrap(~vars) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1)) +
  ylab("Proportion positive change") +
  xlab("Scenario") +
  geom_hline(yintercept = 0.5)
```


```{r}
mang_dens <- modout %>% filter(vars == "BackMang")
ggplot(mang_dens) +
   aes(x = outcomes) + 
  geom_density(color = "red", fill = "pink") +
  facet_wrap(~scnr, scales= "free") + 
  xlim(-10, 10) + 
  xlab("Net outcome") +
  geom_vline(xintercept = 0)
```


```{r}
mang_dens <- modout %>% filter(vars == "FrontMang")
ggplot(mang_dens) +
   aes(x = outcomes) + 
  geom_density(color = "red", fill = "pink") +
  facet_wrap(~scnr, scales= "free") + 
  xlim(-10, 10) + 
  xlab("Net outcome") +
  geom_vline(xintercept = 0)
```


