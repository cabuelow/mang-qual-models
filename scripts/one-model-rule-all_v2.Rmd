---
output: html_document
---

TODO: Create many scenarios to try and test. Figure out whats next. Any uncertain linkages?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(igraph)
library(QPress)
library(tidyverse)
library(patchwork)
theme_set(theme_classic())
source('models.R')
source('helpers.R')
```

# How to build a model 
### Mangrove response to climate change and other anthropogenic threats

Taking a 'one model to rule them all approach' vs. multiple, individual models for different scenarios. We agree there should be only one model structure. If we think the model structure isn't right though, we can test and compare other variations.

Aim is to build one model that performs as expected under different scenarios.

Then we can map likelihood of increase or decrease in mangrove extent, given different drivers

Steps are to:

1) Build and visualise the conceptual model
2) Perturb drivers and simulate to examine expected responses of mangroves under different scenarios
3) If responses are not expected, re-work the conceptual model and do step 2
4) Map likelihood of mangroves increasing or decreasing given different geomorphologies and drivers
5) Validate with GMW data (if possible)

### 1. Build and visualise conceptual model

Variables are in white and drivers are in grey. Red arrows indicate negative effect, black arrows indicate positive effect.

```{r dpi=300, fig.width=7, fig.height=7}
plotmodel <- function(model, name){
w <- adjacency.matrix(model, labels=TRUE)
gdat <- graph_from_adjacency_matrix(t(w),
                                    mode = "directed",
                                    weighted = "b")
E(gdat)$color <- ifelse(E(gdat)$b <0, "red", "black")
#V(gdat)$color <- ifelse(names(V(gdat)) %in% drivers, "grey", "white")
plot(gdat, 
     vertex.size = 10,
     vertex.label.cex = 0.5,
     vertex.label.color = "black",
     edge.arrow.size = 0.3,
     #edge.label = letters[1:length(E(gdat))],
     edge.label.cex = 0.6,
     edge.label.color = "black",
     edge.label.pos = 1,
     main = name)
}
plotmodel(modelA, 'modelA')
```
```{r}
plotmodel(modelAsimp, 'modelA simplified')
```

### 2) Marginal likelihood of the model under different scenarios (probability of generating an observed sample, i.e. model evidence)

#### Scenario 1: High sediment supply
Expect seaward mangroves to increase

#### Scenario 2: High sediment supply and sea-level fall (e.g., during drought)
Expect Seaward mangroves to increase (progradation) and landward mangroves dieback

#### Scenario 3: High sediment supply and sea-level rise
Expect seaward mangroves to prograde, landward mangroves to migrate landward

#### Scenario 4: Sea-level rise
Expect landward mangroves to increase, seaward mangroves to decrease

```{r}

numsims <- 10000
likelihoods <- c()
simA_SLR <- system.simulate(numsims, modelA,
                            validators = list(
                              press.validate(modelA, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               SeawardPropag=-1,
                                                               SeawardMang=-1), 
                                             monitor=c(SeawardMang=-1, LandwardMang=1))
                            ))
marg_likelihood_SLR <- simA_SLR$accepted/simA_SLR$total
marg_likelihood_SLR
likelihoods[1] <- marg_likelihood_SLR

simAsimp_SLR <- system.simulate(numsims, modelAsimp,
                            validators = list(
                              press.validate(modelAsimp, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               SeawardMang=-1), 
                                             monitor=c(SeawardMang=-1, LandwardMang=1))
                            ))
marg_likelihoodsimp_SLR <- simAsimp_SLR$accepted/simAsimp_SLR$total
marg_likelihoodsimp_SLR
likelihoods[6] <- marg_likelihoodsimp_SLR

simA_SedSupp <- system.simulate(numsims, modelA,
                            validators = list(
                              press.validate(modelA, perturb=c(SubVol=1), 
                                   monitor=c(SeawardMang=1))
                            ))
marg_likelihood_SedSupp <- simA_SedSupp$accepted/simA_SedSupp$total
marg_likelihood_SedSupp
likelihoods[2] <- marg_likelihood_SedSupp

simAsimp_SedSupp <- system.simulate(numsims, modelAsimp,
                            validators = list(
                              press.validate(modelAsimp, perturb=c(SubVol=1), 
                                   monitor=c(SeawardMang=1))
                            ))
marg_likelihoodsimp_SedSupp <- simAsimp_SedSupp$accepted/simAsimp_SedSupp$total
marg_likelihoodsimp_SedSupp
likelihoods[7] <- marg_likelihoodsimp_SedSupp

simA_SLR_SedSupp <- system.simulate(numsims, modelA,
                            validators = list(
                              press.validate(modelA, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               SeawardPropag=-1,
                                                               SeawardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=1))
                            ))
marg_likelihood_SLR_SedSupp <- simA_SLR_SedSupp$accepted/simA_SLR_SedSupp$total
marg_likelihood_SLR_SedSupp
likelihoods[3] <- marg_likelihood_SLR_SedSupp

simAsimp_SLR_SedSupp <- system.simulate(numsims, modelAsimp,
                            validators = list(
                              press.validate(modelAsimp, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               #SeawardPropag=-1,
                                                               SeawardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=1))
                            ))
marg_likelihoodsimp_SLR_SedSupp <- simAsimp_SLR_SedSupp$accepted/simAsimp_SLR_SedSupp$total
marg_likelihoodsimp_SLR_SedSupp
likelihoods[8] <- marg_likelihoodsimp_SLR_SedSupp

simA_SLF_SedSupp <- system.simulate(numsims, modelA,
                            validators = list(
                              press.validate(modelA, perturb=c(LandwardLatAccom=-1,
                                                               SeawardLatAccom=1,
                                                               LandwardPropag=-1,
                                                               LandwardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=-1))
                            ))
marg_likelihood_SLF_SedSupp <- simA_SLF_SedSupp$accepted/simA_SLF_SedSupp$total
marg_likelihood_SLF_SedSupp
likelihoods[4] <- marg_likelihood_SLF_SedSupp

simAsimp_SLF_SedSupp <- system.simulate(numsims, modelAsimp,
                            validators = list(
                              press.validate(modelAsimp, perturb=c(LandwardLatAccom=-1,
                                                               SeawardLatAccom=1,
                                                               #LandwardPropag=-1,
                                                               LandwardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=-1))
                            ))
marg_likelihoodsimp_SLF_SedSupp <- simAsimp_SLF_SedSupp$accepted/simAsimp_SLF_SedSupp$total
marg_likelihoodsimp_SLF_SedSupp
likelihoods[9] <- marg_likelihoodsimp_SLF_SedSupp

simA_all <- system.simulate(numsims, modelA,
                            validators = list(
                              press.validate(modelA, perturb=c(LandwardLatAccom=-1,
                                                               SeawardLatAccom=1,
                                                               LandwardPropag=-1,
                                                               LandwardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=-1)),
                               press.validate(modelA, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               SeawardPropag=-1,
                                                               SeawardMang=-1), 
                                             monitor=c(SeawardMang=-1, LandwardMang=1)),
                              press.validate(modelA, perturb=c(SubVol=1), 
                                   monitor=c(SeawardMang=1)),
                               press.validate(modelA, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               SeawardPropag=-1,
                                                               SeawardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=1))
                            ))
marg_likelihood_all <- simA_all$accepted/simA_all$total
marg_likelihood_all
likelihoods[5] <- marg_likelihood_all

simAsimp_all <- system.simulate(numsims, modelAsimp,
                            validators = list(
                              press.validate(modelAsimp, perturb=c(LandwardLatAccom=-1,
                                                               SeawardLatAccom=1,
                                                               #LandwardPropag=-1,
                                                               LandwardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=-1)),
                               press.validate(modelAsimp, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               SeawardMang=-1), 
                                             monitor=c(SeawardMang=-1, LandwardMang=1)),
                               press.validate(modelAsimp, perturb=c(SubVol=1), 
                                   monitor=c(SeawardMang=1)),
                              press.validate(modelAsimp, perturb=c(LandwardLatAccom=1,
                                                               SeawardLatAccom=-1,
                                                               #SeawardPropag=-1,
                                                               SeawardMang=-1,
                                                               SubVol=1), 
                                             monitor=c(SeawardMang=1, LandwardMang=1))
                            ))
marg_likelihoodsimp_all <- simAsimp_all$accepted/simAsimp_all$total
marg_likelihoodsimp_all
likelihoods[10] <- marg_likelihoodsimp_all

datplot <- data.frame(scenario = rep(c('SLR', 'Sediment supply', 'SLR & Sediment supply', 'SLF & Sediment supply', 'All'),2),
                      model = c(rep('Complex', 5), rep('Simple', 5)),
                      likelihood = likelihoods)

ggplot(datplot) +
  aes(x = scenario, y = likelihoods) +
  geom_bar(stat = 'identity') +
  facet_wrap(~model) +
  ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 20,
                                   hjust = 1)) +
  ylab("Model evidence") +
  xlab("Scenario") +
  geom_hline(yintercept = 0.5)
```
Model evidence is generally low, and similar for both the simple and complex models in each scenario. There are very few models that are stable and valid under all scenarios. 
But this is with randomised linkage weights. So potentially some simulated models are not valid because they have incorrect weights. 

We will use complex model for further investigation.

### 3) Predicted response of mangroves under different scenarios

Here we only consider models that are stable to estimate the probability of different mangrove responses (evaluation of model evidence above includes all models that are simulated (stable + unstable))

Blue is the probability of mangrove landward migration under each scenario.
Red is the probability of mangrove seaward migration (i.e., progradation) under each scenario.

```{r}
modout <- lapply(1:10000, simulate_scenarios)
modout <- do.call("rbind", modout)

# calculate probability of progradation or landward migration under each scenario

seaward <- modout %>% 
  filter(vars == 'SeawardMang') %>% 
  group_by(scnr) %>% 
  summarise(Increase = sum(outcomes>0)/n(),
            Neutral = sum(outcomes==0)/n(),
            Decrease = sum(outcomes<0)/n()) %>% 
  pivot_longer(Increase:Decrease ,names_to = 'outcome', values_to = 'prop') %>% 
  mutate(outcome = factor(outcome, levels = c('Increase', 'Neutral', 'Decrease')))

landward <- modout %>% 
  filter(vars == 'LandwardMang') %>% 
  group_by(scnr) %>% 
    summarise(Increase = sum(outcomes>0)/n(),
            Neutral = sum(outcomes==0)/n(),
            Decrease = sum(outcomes<0)/n()) %>% 
  pivot_longer(Increase:Decrease ,names_to = 'outcome', values_to = 'prop') %>% 
  mutate(outcome = factor(outcome, levels = c('Increase', 'Neutral', 'Decrease')))

# Note, as potential TODO could boostrap resample here to get estimate of uncertainty around that probability

a <- ggplot(seaward) +
  geom_bar(aes(y = scnr, x = prop, fill = outcome),
           position = 'stack', stat = 'identity') +
  xlab('Proportion of outcomes') +
  ylab('') +
  theme(legend.position = 'none') +
  ggtitle('Seaward mangroves')

b <- ggplot(landward) +
  geom_bar(aes(y = scnr, x = prop, fill = outcome),
           position = 'stack', stat = 'identity') +
  xlab('Proportion of outcomes') +
  ylab('') +
  ggtitle('Landward mangroves') +
  theme(legend.title = element_blank(),
        axis.text.y =  element_blank())

a+b
```
Mangroves will prograde under scenarios of high sediment supply and sea level fall.
Mangroves will migrate landward under scenarios of sea level rise and sediment supply. Decrease under sediment supply and sea-level fall.

Under these limited scenarios, suggests that whether landward mangroves will increase or decrease in more certain than for seaward mangroves under most scenarios.
TODO: more scenarios, including restoration etc...

### 4) For each scenario, get models that are valid, construct probability distribiution of likely parameter values

Quantify and compare uncertainty in parameters. Where are valid parameters most uncertain? This suggest where we should focus our attention to resolve uncertainty in parameters (e.g., collect more/better data) to make better predictions.

Use the system.simulate function. Here all the 'accepted' matrices/models are a) stable, and b) meet the scenario validation criteria.

```{r}

params <- data.frame(rbind(simA_SLR$w, simA_SedSupp$w, simA_SLR_SedSupp$w, simA_SLF_SedSupp$w, simA_all$w))

params$scnr <- rep(c("SLR", "Sediment supply", "Sediment supply & SLR", "Sediment supply & SLF", 'All'), each = numsims)

params <- params %>% pivot_longer(LandwardLatAccom....LandwardPropag:SubVol....SubVol, 
                         names_to = "link", values_to = 'weight')

params$from_var <- sapply(strsplit(as.character(params$link), "\\."), `[`, 1)
params$to_var <- sapply(strsplit(as.character(params$link), "\\."), `[`, 5)

ggplot() +
  geom_density(data = filter(params, scnr == 'SLR'), 
               aes(x = weight), colour = 'blue', fill = 'blue', alpha = 0.2) +
   geom_density(data = filter(params, scnr == 'Sediment supply'), 
               aes(x = weight), colour = 'yellow', fill = 'yellow', alpha = 0.2) +
   geom_density(data = filter(params, scnr == 'Sediment supply & SLR'), 
               aes(x = weight), colour = 'green', fill = 'green', alpha = 0.2) +
   geom_density(data = filter(params, scnr == 'Sediment supply & SLF'), 
               aes(x = weight), colour = 'red', fill = 'red', alpha = 0.2) +
   geom_density(data = filter(params, scnr == 'All'), 
               aes(x = weight), colour = 'purple', fill = 'purple', alpha = 0.2) +
  facet_wrap(~link, scales = 'free') +
  theme(strip.text.x = element_text(size = 5))

```
The scenarios are valid under a generally very ambiguous set of parameter weights. 
That probably means our predictions are very uncertain too.

TODO: Try to put tighter constraints on parameter values with more scenario validation
Make this into a function and put in an app, so that you can easily select for very complicated press perturbation scenarios for all drivers, and see outcome.










